<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Laika 0.18.1 + Helium Theme" />
    <title>circuit - Circuit Breaker for Scala <a href="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12"><img src="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12/badge.svg" alt="Maven Central"></a></title>
    
      <meta name="author" content="Christopher Davenport"/>
    
    
      <meta name="description" content="site"/>
    
    
      <link rel="icon" sizes="32x32" type="image/png" href="https://typelevel.org/img/favicon.png"/>
    
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
    
    <link rel="stylesheet" type="text/css" href="helium/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="helium/laika-helium.css" />
    <link rel="stylesheet" type="text/css" href="site/styles.css" />
    <script src="helium/laika-helium.js"></script>
    
    
    <script> /* for avoiding page load transitions */ </script>
  </head>

  <body>

    <header id="top-bar">

      <div class="row">
        <a id="nav-icon">
          <i class="icofont-laika" title="Navigation">&#xefa2;</i>
        </a>
        
      </div>

      <a class="image-link" href="https://typelevel.org"><img src="https://typelevel.org/img/logo.svg"></a>

      <span class="row links"><a class="icon-link svg-link" href="https://github.com/davenverse/circuit"><span title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a><a class="icon-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika" title="Chat">&#xeed5;</i></a><a class="icon-link" href="https://twitter.com/typelevel"><i class="icofont-laika" title="Twitter">&#xed7a;</i></a></span>

    </header>

    <nav id="sidebar">

      <div class="row">
        <a class="icon-link svg-link" href="https://github.com/davenverse/circuit"><span title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a><a class="icon-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika" title="Chat">&#xeed5;</i></a><a class="icon-link" href="https://twitter.com/typelevel"><i class="icofont-laika" title="Twitter">&#xed7a;</i></a>
      </div>

      <ul class="nav-list">
        <li class="level1 active"><a href="#">circuit - Circuit Breaker for Scala <a href="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12"><img src="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12/badge.svg" alt="Maven Central"></a></a></li>
      </ul>

      <ul class="nav-list">
        <li class="level1 nav-header">Related Projects</li>
        
          <li class="level2"><a href="https://typelevel.org/cats/">cats</a></li>
        
      </ul>

    </nav>

    <div id="container">

      <nav id="page-nav">
        <p class="header"><a href="#">circuit - Circuit Breaker for Scala <a href="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12"><img src="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12/badge.svg" alt="Maven Central"></a></a></p>

        <ul class="nav-list">
          <li class="level1"><a href="#quick-start">Quick Start</a></li>
          <li class="level1"><a href="#purpose">Purpose</a></li>
          <li class="level1"><a href="#how-it-works">How It Works</a></li>
          <li class="level1"><a href="#usage">Usage</a></li>
          <li class="level1"><a href="#credits">Credits</a></li>
        </ul>

        <p class="footer"></p>
      </nav>

      <main class="content">

        <h1 id="circuit-circuit-breaker-for-scala" class="title">circuit - Circuit Breaker for Scala <a href="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12"><img src="https://maven-badges.herokuapp.com/maven-central/io.chrisdavenport/circuit_2.12/badge.svg" alt="Maven Central"></a></h1>
        <p>The <code>CircuitBreaker</code> is used to provide stability and prevent cascading failures in distributed systems.</p>
        
        <h2 id="quick-start" class="section">Quick Start<a class="anchor-link right" href="#quick-start"><i class="icofont-laika">&#xef71;</i></a></h2>
        <p>To use circuit in an existing SBT project with Scala 2.11 or a later version, add the following dependencies to your
        <code>build.sbt</code> depending on your needs:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">libraryDependencies</span><span> ++= </span><span class="type-name">Seq</span><span>(
  </span><span class="string-literal">&quot;io.chrisdavenport&quot;</span><span> %% </span><span class="string-literal">&quot;circuit&quot;</span><span> % </span><span class="string-literal">&quot;&lt;version&gt;&quot;</span><span>
)</span></code></pre>
        
        <h2 id="purpose" class="section">Purpose<a class="anchor-link right" href="#purpose"><i class="icofont-laika">&#xef71;</i></a></h2>
        <p>As an example, we have a web application interacting with a remote
        third party web service. Let&#39;s say the third party has oversold
        their capacity and their database melts down under load. Assume
        that the database fails in such a way that it takes a very long
        time to hand back an error to the third party web service. This in
        turn makes calls fail after a long period of time.  Back to our
        web application, the users have noticed that their form
        submissions take much longer seeming to hang. Well the users do
        what they know to do which is use the refresh button, adding more
        requests to their already running requests.  This eventually
        causes the failure of the web application due to resource
        exhaustion. This will affect all users, even those who are not
        using functionality dependent on this third party web service.</p>
        <p>Introducing circuit breakers on the web service call would cause
        the requests to begin to fail-fast, letting the user know that
        something is wrong and that they need not refresh their
        request. This also confines the failure behavior to only those
        users that are using functionality dependent on the third party,
        other users are no longer affected as there is no resource
        exhaustion. Circuit breakers can also allow savvy developers to
        mark portions of the site that use the functionality unavailable,
        or perhaps show some cached content as appropriate while the
        breaker is open.</p>
        
        <h2 id="how-it-works" class="section">How It Works<a class="anchor-link right" href="#how-it-works"><i class="icofont-laika">&#xef71;</i></a></h2>
        <p>The circuit breaker models a concurrent state machine that
        can be in any of these 3 states:</p>
        <p><strong>Closed</strong>: During normal operations or when the <code>CircuitBreaker</code> starts</p>
        <ul>
          <li>
            <p>Exceptions increment the <code>failures</code> counter</p>
          </li>
          <li>
            <p>Successes reset the failure count to zero</p>
          </li>
          <li>
            <p>When the <code>failures</code> counter reaches the <code>maxFailures</code> count,the breaker is tripped into <code>Open</code> state</p>
          </li>
        </ul>
        <p><strong>Open</strong>: The circuit breaker rejects all tasks with an RejectedExecution</p>
        <ul>
          <li>
            <p>all tasks fail fast with <code>RejectedExecution</code></p>
          </li>
          <li>
            <p>after the configured <code>resetTimeout</code>, the circuit breaker enters a <code>HalfOpen</code> state, allowing one task to go through for testing the connection</p>
          </li>
        </ul>
        <p><strong>HalfOpen</strong>: The circuit breaker has already allowed a task to go through, as a reset attempt, in order to test the connection</p>
        <ul>
          <li>
            <p>The first task when <code>Open</code> has expired is allowed through without failing fast, just before the circuit breaker is evolved into the <code>HalfOpen</code> state</p>
          </li>
          <li>
            <p>All tasks attempted in <code>HalfOpen</code> fail-fast with an exception just as in <code>Open</code> state</p>
          </li>
          <li>
            <p>If that task attempt succeeds, the breaker is reset back to the <code>Closed</code> state, with the <code>resetTimeout</code> and the <code>failures</code> count also reset to initial values</p>
          </li>
          <li>
            <p>If the first call fails, the breaker is tripped again into the <code>Open</code> state (after the inital <code>resetTimeout</code> it&#39;s passed to <code>backoff</code> to calculate the next timeout)</p>
          </li>
        </ul>
        
        <h2 id="usage" class="section">Usage<a class="anchor-link right" href="#usage"><i class="icofont-laika">&#xef71;</i></a></h2>
        <p>First some imports.</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">io</span><span>.</span><span class="identifier">chrisdavenport</span><span>.</span><span class="identifier">circuit</span><span>.{</span><span class="type-name">Backoff</span><span>, </span><span class="type-name">CircuitBreaker</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">scala</span><span>.</span><span class="identifier">concurrent</span><span>.</span><span class="identifier">duration</span><span>.</span><span class="identifier">_</span></code></pre>
        <p>Then we construct the circuit breaker.</p>
        <pre><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">circuitBreaker</span><span> = </span><span class="type-name">CircuitBreaker</span><span>.</span><span class="identifier">of</span><span>[</span><span class="type-name">IO</span><span>](
  </span><span class="identifier">maxFailures</span><span> = </span><span class="number-literal">5</span><span>,
  </span><span class="identifier">resetTimeout</span><span> = </span><span class="number-literal">10</span><span>.</span><span class="identifier">seconds</span><span>
)
</span><span class="comment">// circuitBreaker: IO[CircuitBreaker[IO]] = Map(
//   ioe = Delay(
//     thunk = cats.effect.IO$$$Lambda$9691/647016446@634b541c,
//     event = cats.effect.tracing.TracingEvent$StackTrace
//   ),
//   f = io.chrisdavenport.circuit.CircuitBreaker$Builder$$Lambda$9693/1838835957@7adc43c9,
//   event = cats.effect.tracing.TracingEvent$StackTrace
// )
</span><span>
</span><span class="comment">//...
</span><span class="keyword">val</span><span> </span><span class="identifier">problematic</span><span> = </span><span class="type-name">IO</span><span> {
  </span><span class="keyword">val</span><span> </span><span class="identifier">nr</span><span> = </span><span class="identifier">scala</span><span>.</span><span class="identifier">util</span><span>.</span><span class="type-name">Random</span><span>.</span><span class="identifier">nextInt</span><span>()
  </span><span class="keyword">if</span><span> (</span><span class="identifier">nr</span><span> % </span><span class="number-literal">2</span><span> == </span><span class="number-literal">0</span><span>) </span><span class="identifier">nr</span><span> </span><span class="keyword">else</span><span>
    </span><span class="keyword">throw</span><span> </span><span class="keyword">new</span><span> </span><span class="type-name">RuntimeException</span><span>(</span><span class="string-literal">&quot;dummy&quot;</span><span>)
}
</span><span class="comment">// problematic: IO[Int] = Delay(
//   thunk = &lt;function0&gt;,
//   event = cats.effect.tracing.TracingEvent$StackTrace
// )
</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">task</span><span> = </span><span class="identifier">circuitBreaker</span><span>.</span><span class="identifier">flatMap</span><span>(
  </span><span class="identifier">_</span><span>.</span><span class="identifier">protect</span><span>(</span><span class="identifier">problematic</span><span>) </span><span class="comment">// Circuit Breaker Shared State Location
</span><span>)
</span><span class="comment">// task: IO[Int] = FlatMap(
//   ioe = Map(
//     ioe = Delay(
//       thunk = cats.effect.IO$$$Lambda$9691/647016446@634b541c,
//       event = cats.effect.tracing.TracingEvent$StackTrace
//     ),
//     f = io.chrisdavenport.circuit.CircuitBreaker$Builder$$Lambda$9693/1838835957@7adc43c9,
//     event = cats.effect.tracing.TracingEvent$StackTrace
//   ),
//   f = &lt;function1&gt;,
//   event = cats.effect.tracing.TracingEvent$StackTrace
// )</span></code></pre>
        <p>When attempting to close the circuit breaker and resume normal operations, we can also apply an exponential backoff for repeated failed attempts, like so:</p>
        <pre><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">exponential</span><span> = </span><span class="type-name">CircuitBreaker</span><span>.</span><span class="identifier">of</span><span>[</span><span class="type-name">IO</span><span>](
  </span><span class="identifier">maxFailures</span><span> = </span><span class="number-literal">5</span><span>,
  </span><span class="identifier">resetTimeout</span><span> = </span><span class="number-literal">10</span><span>.</span><span class="identifier">seconds</span><span>,
  </span><span class="identifier">backoff</span><span> = </span><span class="type-name">Backoff</span><span>.</span><span class="identifier">exponential</span><span>,
  </span><span class="identifier">maxResetTimeout</span><span> = </span><span class="number-literal">10</span><span>.</span><span class="identifier">minutes</span><span>
)
</span><span class="comment">// exponential: IO[CircuitBreaker[IO]] = Map(
//   ioe = Delay(
//     thunk = cats.effect.IO$$$Lambda$9691/647016446@9c8b347,
//     event = cats.effect.tracing.TracingEvent$StackTrace
//   ),
//   f = io.chrisdavenport.circuit.CircuitBreaker$Builder$$Lambda$9693/1838835957@376436d2,
//   event = cats.effect.tracing.TracingEvent$StackTrace
// )</span></code></pre>
        <p>In this sample we attempt to reconnect after 10 seconds, then after
        20, 40 and so on, a delay that keeps increasing up to a configurable
        maximum of 10 minutes.</p>
        
        <h2 id="credits" class="section">Credits<a class="anchor-link right" href="#credits"><i class="icofont-laika">&#xef71;</i></a></h2>
        <p>This data type was inspired by the availability of <a href="http://doc.akka.io/docs/akka/current/common/circuitbreaker.html">Akka&#39;s Circuit Breaker</a> and ported to cats-effect from <a href="https://monix.io">Monix</a> and when its merger halted there, it was moved to <a href="https://github.com/ChristopherDavenport/circuit">circuit</a>. The initial implementation and port by Alexandru Nedelcu and Oleg Pyzhcov was what enabled this ref based version to exist.</p>

        <hr style="margin-top: 30px"/>
        <footer style="font-size: 90%; text-align: center">
          circuit is a <a href="https://typelevel.org/">Typelevel</a> project distributed under the <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache-2.0</a> license.
        </footer>

      </main>

    </div>

  </body>
</html>
